<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Evaluation Schedule Simulation System - E3S</title>
		<link href="./favicon.png" rel="icon" />
		<link href="./style.css" rel="stylesheet" />
		<style>
#testButton{
	border-bottom: var(--border-dark);
	border-left: var(--border-light);
	border-right: var(--border-dark);
	border-top: var(--border-light);
	font: inherit;
	outline: 0;
	padding: 0.45rem;
	text-align: center;
}
#testButton:active{
	border-bottom: var(--border-light);
	border-left: var(--border-dark);
	border-right: var(--border-light);
	border-top: var(--border-dark);
}
h1{
	background: linear-gradient(90deg,rgb(127,127,127),transparent);
	font-size: 2rem;
	margin: 1rem 0;
	padding: 1rem;
}
h2{
	background: linear-gradient(90deg,rgb(255,127,127),transparent);
	font-size: 1.8rem;
	margin: 1rem 0;
	padding: 1rem;
}
p{
	font-size: 1rem;
	margin: 1rem 0;
}
a{
	color: dodgerblue;
	text-decoration: none;
}
		</style>
	</head>
	<body>
		<h1>Evaluation Schedule Simulation System - E3S</h1>
		<section>
			<h2>E3Sとは？</h2>
			<p>E3Sは、信頼性試験の日程表の作成を補助する<a href="./">ツール</a>です。</p>
		</section>
		<section>
			<h2>インターフェースについて</h2>
			<p>コンテンツを読み込むと、以下のインターフェースが表示されます。</p>
			<div id="interface" style="pointer-events: none;">
				<div style="grid-column: 2;grid-row: 2;">開始時間</div>
				<div style="grid-column: 2;grid-row: 3;">終了時間</div>
				<div style="grid-column: 2;grid-row: 4;">ステップ時間</div>
				<div style="grid-column: 2;grid-row: 5;">非稼働日の一覧</div>
				<div style="grid-column: 2;grid-row: 6;">非営業日の一覧</div>
				<input id="inputStart" placeholder="0" style="grid-column: 3;grid-row: 2;" text" value="0" />
				<input id="inputFinish" placeholder="1000" style="grid-column: 3;grid-row: 3;" text" value="1000" />
				<input id="inputSpan" placeholder="250" style="grid-column: 3;grid-row: 4;" text" value="250" />
				<button id="clickImmobileListPicker" style="grid-column: 3;grid-row: 5;">選択する</button>
				<button id="clickHolidayListPicker" style="grid-column: 3;grid-row: 6;">選択する</button>
				<div style="grid-column: 5;grid-row: 2;">年</div>
				<div style="grid-column: 5;grid-row: 3;">月</div>
				<div style="grid-column: 5;grid-row: 4;">日</div>
				<div style="grid-column: 5;grid-row: 5;">時</div>
				<div style="grid-column: 5;grid-row: 6;">分</div>
				<input id="inputYear" placeholder="YYYY" style="grid-column: 6;grid-row: 2;" text" value="2019" />
				<input id="inputMonth" placeholder="MM" style="grid-column: 6;grid-row: 3;" text" value="1" />
				<input id="inputDate" placeholder="DD" style="grid-column: 6;grid-row: 4;" text" value="1" />
				<input id="inputHour" placeholder="hh" style="grid-column: 6;grid-row: 5;" text" value="17" />
				<input id="inputMinute" placeholder="mm" style="grid-column: 6;grid-row: 6;" text" value="0" />
				<button id="runButton" style="grid-column: 8;grid-row: 3;">実行する</button>
				<button id="copyButton" style="grid-column: 8;grid-row: 5;">コピーする</button>
			</div>
			<table id="resultTable"></table>
			<p>インターフェースの各項目に値を入力し、[実行する]ボタンを押すことで、日程が算出されます。<br><!--
			-->また、[コピーする]ボタンを押すことで、算出された表がグリップボードにコピーされます。<br><!--
			-->コピーされた表は、直接エクセルに貼り付けられます。<br><!--
			-->下の[Run]ボタンを押すと、動作のサンプルが開始されます。</p>
			<button id="testButton">Run</button>
		</section>
		<script>
(function(){
	"use strict";
	const testButton=document.querySelector("#testButton");
	const inputStart=document.querySelector("#inputStart");
	const inputFinish=document.querySelector("#inputFinish");
	const inputSpan=document.querySelector("#inputSpan");
	const inputYear=document.querySelector("#inputYear");
	const inputMonth=document.querySelector("#inputMonth");
	const inputDate=document.querySelector("#inputDate");
	const inputHour=document.querySelector("#inputHour");
	const inputMinute=document.querySelector("#inputMinute");
	const runButton=document.querySelector("#runButton");
	const copyButton=document.querySelector("#copyButton");
	const resultTable=document.querySelector("#resultTable");
	const cache=[],IMMOBILE_LIST=[],HOLIDAY_LIST=[];
	let base,distance,finish,loop,span,start,temp,total;
	function setFocusBorder(element){
		element.style.border="solid 0.05rem red";
		element.value="";
	}
	function setLowerBorder(element){
		element.style.borderBottom="var(--border-light)";
		element.style.borderLeft="var(--border-dark)";
		element.style.borderRight="var(--border-light)";
		element.style.borderTop="var(--border-dark)";
	}
	function setUpperBorder(element){
		element.style.borderBottom="var(--border-dark)";
		element.style.borderLeft="var(--border-light)";
		element.style.borderRight="var(--border-dark)";
		element.style.borderTop="var(--border-light)";
	}
	testButton.addEventListener("click",function(event){
		let progress=0;
		const interval=setInterval(function(){
			switch(progress){
				case 0:
					setFocusBorder(inputStart);
					break;
				case 1:
					inputStart.value="1";
					break;
				case 2:
					inputStart.value="10";
					break;
				case 3:
					inputStart.value="100";
					break;
				case 4:
					inputStart.value="1000";
					break;
				case 5:
					setLowerBorder(inputStart);
					setFocusBorder(inputFinish);
					break;
				case 6:
					inputFinish.value="3";
					break;
				case 7:
					inputFinish.value="30";
					break;
				case 8:
					inputFinish.value="300";
					break;
				case 9:
					inputFinish.value="3000";
					break;
				case 10:
					setLowerBorder(inputFinish);
					setFocusBorder(inputSpan);
					break;
				case 11:
					inputSpan.value="5";
					break;
				case 12:
					inputSpan.value="50";
					break;
				case 13:
					inputSpan.value="500";
					break;
				case 14:
					setLowerBorder(inputSpan);
					setFocusBorder(inputYear);
					break;
				case 15:
					inputYear.value="2";
					break;
				case 16:
					inputYear.value="20";
					break;
				case 17:
					inputYear.value="202";
					break;
				case 18:
					inputYear.value="2020";
					break;
				case 19:
					setLowerBorder(inputYear);
					setFocusBorder(inputMonth);
					break;
				case 20:
					inputMonth.value="4";
					break;
				case 21:
					setLowerBorder(inputMonth);
					setFocusBorder(inputDate);
					break;
				case 22:
					inputDate.value="1";
					break;
				case 23:
					inputDate.value="15";
					break;
				case 24:
					setLowerBorder(inputDate);
					setFocusBorder(inputHour);
					break;
				case 25:
					inputHour.value="1";
					break;
				case 26:
					inputHour.value="16";
					break;
				case 27:
					setLowerBorder(inputHour);
					setFocusBorder(inputMinute);
					break;
				case 28:
					inputMinute.value="0";
					break;
				case 29:
					setLowerBorder(inputMinute);
					setFocusBorder(runButton);
					break;
				case 30:
					runButton.click();
					break;
				case 31:
					setUpperBorder(runButton);
					clearInterval(interval);
					progress=0;
					break;
			}
			progress++;
		},500);
	},false);
	runButton.addEventListener("click",onClick,false);
	copyButton.addEventListener("click",onClick,false);
	function onClick(event){
		switch(event.target){
			case runButton:
				reset();
				while(main());
				break;
			case copyButton:
				copy(resultTable);
				break;
		}
	}
	function reset(){
		start=parseInt(inputStart.value);
		finish=parseInt(inputFinish.value);
		span=parseInt(inputSpan.value);
		total=0;
		loop=Math.floor(start/span);
		distance=0;
		temp=new Date(`${inputYear.value}/${inputMonth.value}/${inputDate.value} ${inputHour.value}:${inputMinute.value}`);
		base=temp.getTime();
		cache.length=0;
		resultTable.innerHTML="";
		output(["年","月","日","時","分","年","月","日","時","分","経過","停止理由"]);
	}
	function main(){
		save(temp);
		update(10);
		while(parse(temp.getTime()-base)<span*(loop+1)+7*loop+distance-start){
			temp.setDate(temp.getDate()+1);
			if(search())
				return true;
		}
		while(check(temp))
			temp.setDate(temp.getDate()+1);
		total=parse(temp.getTime()-base)-7*loop-distance+start;
		save(temp);
		output(cache.concat([total,""]));
		cache.length=0;
		loop++;
		update(17);
		return total<finish;
	}
	function update(hour){
		if(temp.getHours()>hour)
			temp.setDate(temp.getDate()+1);
		temp.setHours(hour);
	}
	function parse(millisecond){
		return Math.floor(millisecond/3600000);
	}
	function search(){
		let flag=false;
		IMMOBILE_LIST.forEach(function(currentValue,index,array){
			const [period,reason]=currentValue.split("_");
			const [stop,restart]=period.split("~");
			if(convert(temp).split(" ")[0]==stop.split(" ")[0]){
				const stopDate=new Date(stop);
				save(stopDate);
				total=parse(stopDate.getTime()-base)-7*loop-distance+start;
				temp=new Date(restart);
				distance+=parse(temp.getTime()-stopDate.getTime());
				flag=true;
				output(cache.concat([total,reason]));
				cache.length=0;
				if(total>=loop*span)
					loop++;
			}
		});
		return flag;
	}
	function convert(date){
		return `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
	}
	function save(date){
		cache.push(date.getFullYear());
		cache.push(date.getMonth()+1);
		cache.push(date.getDate());
		cache.push(date.getHours());
		cache.push(date.getMinutes());
	}
	function output(data){
		const tr=document.createElement("tr");
		data.forEach(function(currentValue,index,array){
			const td=document.createElement("td");
			td.textContent=currentValue;
			tr.appendChild(td);
		});
		resultTable.appendChild(tr);
	}
	function check(date){
		return HOLIDAY_LIST.includes(`${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}`)||date.getDay()%6==0;
	}
	function copy(element){
		const range=document.createRange();
		range.selectNode(element);
		const selection=window.getSelection();
		selection.removeAllRanges();
		selection.addRange(range);
		document.execCommand("copy");
		selection.removeRange(range);
	}
})();
		</script>
	</body>
</html>